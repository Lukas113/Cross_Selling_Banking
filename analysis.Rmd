---
title: "HS19C2 - Cross-Selling in Banking"
output:
  html_document:
    df_print: paged
  pdf_document: default
---

### SQL - Connection
```{r}
library("RPostgreSQL")

# define the database connection string
DB_HOST='server2053.cs.technik.fhnw.ch' # or 86.119.36.94 depending on the network
DB_PORT = 5432
DB_DBNAME = 'bank_db' # or 'warenkorb_db'
DB_USERNAME = 'db_user' 
DB_PASSWORD = 'db_user_pw' 

# load the PostgreSQL driver
drv <- dbDriver("PostgreSQL")
# connect to the database
con <- dbConnect(drv, dbname = DB_DBNAME,
                 host = DB_HOST, port = DB_PORT,
                 user = DB_USERNAME, password = DB_PASSWORD)

```

#### Erzeugung eines Inline-Chunks in R
- Datum: `r date()`

### Infos
- Bereits vorhandene Services: Darlehen und Kredit-Kart

### Besprechung 16.10.

#### Tabelle account
- «date»: Eröffnungsdaten von Konten: 1993 bis und mit 1997 (5 Jahre)
- «frequency»: Frequenz von Ausstellung der Kontoauszüge

#### Tabelle client (Märki)
- Neue Spalte «gender» aus «birth_number» erstellen
- Neue Spalte «birthdate» aus «birth_number» erstellen im Format YYYY-MM-DD. Achtung Daten bis 1997, sprich 00 = 1900

- Stichtag Alter: 31.12.1998
- Berechnung von Alter könnte man schöner machen, indem man direkt die birthdate Spalte benutzt (Falls dies möglich ist)
```{r}
dataClient = dbGetQuery(con, "SELECT *,
	CASE WHEN MOD(birth_number / 100, 100) > 50 THEN 
		'f'
	ELSE
		'm'
	END as gender,
	CASE WHEN MOD(birth_number / 100, 100) > 50 THEN
		TO_DATE(CONCAT('19', CAST(birth_number-5000 AS VARCHAR(6))), 'YYYYMMDD')
	ELSE
		TO_DATE(CONCAT('19', CAST(birth_number AS VARCHAR(6))), 'YYYYMMDD')
	END as birthdate,
	EXTRACT(YEAR FROM AGE('1998-12-31', CASE WHEN MOD(birth_number / 100, 100) > 50 THEN TO_DATE(CONCAT('19', CAST(birth_number-5000 AS VARCHAR(6))), 'YYYYMMDD') ELSE TO_DATE(CONCAT('19', CAST(birth_number AS VARCHAR(6))), 'YYYYMMDD') END)) as age
FROM client LIMIT 10")

print(dataClient)
```

#### Tabelle disp (Gehrig)
- Auffälligkeit: Identische «disp_id» und «client_id» bis «client_id» 8777 (Zeile 4987)

#### Tabelle orders (Stähli)
- Gewisse Zeilen enthalten kein «k_symbol»
  - Unsaubere Klassifizierung -> Zuweisung der Kategorie unbekannt
- Welche Einheit ist «amount»
  - Die Währung ist die Tschechische Krone
- Frequenz und Datum von Daueraufträge prüfen 

```{sql connection=con, output.var = "permanent_orders"}
SELECT trans.trans_id, trans.date, orders.orders_id, orders.account_id, orders.account_to, orders.amount,  
CASE 
	WHEN orders.k_symbol = 'SIPO' THEN 'household' 
	WHEN orders.k_symbol = 'LEASING' THEN 'leasing'
	WHEN orders.k_symbol = 'UVER' THEN 'loan payment'
	WHEN orders.k_symbol = 'POJISTNE' THEN 'insurrance payment'
	WHEN orders.k_symbol = ' ' THEN 'NA'
END
FROM orders
INNER JOIN trans ON orders.account_id = trans.account_id
WHERE orders.amount = trans.amount 
ORDER BY account_id, orders_id, date
```


#### Tabelle trans (Märki)
- Gewisse Zeilen haben einen 0 «amount»
- Es gibt null Werte bei «operation», «k_symbol», «bank» und «account»
- Wenn «operation» null, scheint k_symbol «UROK» (Zinsgutschriften) zu sein
- Heraussuchen wer fast keine Transaktionen hat (Tote Menschen)

- Auffälligkeit: Der Zeitraum der Transaktionen ist, anders als bei den Accounts, von 1993 - 1998 (6 Jahre)

```{r}
dataTransaction = dbGetQuery(con, "SELECT
	trans_id, account_id, date,
	 CASE type
		WHEN 'PRIJEM' THEN 'credit'
		WHEN 'VYDAJ' THEN 'withdrawal'
		ELSE 'undefined'
	END AS type,
	CASE operation
		WHEN 'VYBER KARTOU' THEN 'credit card withdrawal'
		WHEN 'VKLAD' THEN 'credit in cash'
		WHEN 'PREVOD Z UCTU' THEN 'collection from another bank'
		WHEN 'VYBER' THEN 'withdrawal in cash'
		WHEN 'PREVOD NA UCET' THEN 'remittance to another bank'
		ELSE 'undefined'
	END AS operation,
	amount, balance,
	CASE k_symbol
		WHEN 'POJISTNE' THEN 'insurrance payment'
		WHEN 'SLUZBY' THEN 'payment for statement'
		WHEN 'UROK' THEN 'interest credited'
		WHEN 'SANKC. UROK' THEN 'sanction interest if negative balance'
		WHEN 'SIPO' THEN 'household'
		WHEN 'DUCHOD' THEN 'old-age pension'
		WHEN 'UVER' THEN 'loan payment'
		ELSE 'undefined'
	END AS k_symbol,
	bank, account
FROM trans
order by date asc
LIMIT 10")

print(dataTransaction)
```

#### Tabelle loans (Gehrig)
- «duration» ist wahrscheinlich in Monaten
- «status» unterteilt Kunden in Darlehen abgeschlossen/läuft und bezahlt pünktlich/in rückstand
- Tabelle «loans» mit «trans» vergleichen. Werden Rückzahlungen in «trans» abgebildet?
- Herausfinden, ob ein Account mehrere Loans hat

#### Tabelle card

#### Tabelle district (Stähli)
- Spalten sprechend benennen gemäss Beschreibung
- district id 69 hat bei A12 und A15 ein «null», bitte vervollständigen

```{sql connection=con, output.var = "district"}
SELECT a1 as district_code, a2 as district_name,
a3 as region, a4 as no_of_inhabitants, a5 as municipalities_u499,
a6 as municipalties_500_1999, a7 as municipalties_2000_9999, a8 as municipalties_o9999,
a9 as no_of_cities, a10 as ratio_urban_inhabitants, a11 as avg_salary,
a12 as unemploymt_rate95, a13 as unemploymt_rate96, a14 as no_enterpreneurs_per_1000,
a15 as commited_crimes95, a16 as commited_crimes96 
from district
```

```{r}
#str(district)
```

#### Close SQL - Connection
```{r}
dbDisconnect(con)
dbUnloadDriver(drv)
```

