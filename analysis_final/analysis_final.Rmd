---
title: "Analyse zu «HS19C2 - Cross-Selling in Banking»"
author:
  - Lukas Gehrig, Simon Stähli, Lukas Märki
date: "`r format(Sys.time(), '%d.%m.%Y')`"
output:
  html_document:
    df_print: paged
    css: style.css
  pdf_document: default
---

```{r message=FALSE, echo=FALSE}
source('inc/header.R')
```

Eine tschechische Bank möchte ihre Dienstleistungen für Privatkunden verbessern und hat uns beauftragt “interessante Kundengruppen” zu identifizieren. Die Geschäftsleitung hat keine präzise Vorstellung, möchte aber zusätzliches Business generieren ohne unnötige Risiken einzugehen und Verluste einzufahren.  
Kunde: Prof. Dr. Daniel Perruchoud

```{r}
cbPalette <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")
scale_fill_cb <- scale_fill_manual(values = cbPalette)
scale_color_cb <- scale_color_manual(values = cbPalette)
```


# 1. Qualität und Representativität der Daten

In den Daten sind alle Konten enthalten, welche im Zeitraum von 1.1.1993 bis 29.12.1997 eröffnet worden sind. Insgesamt sind 4'500 Konten in diesem Zeitraum eröffnet worden.  
Die Daten der getätigten Transaktionen und Ausstelldaten der Kreditkarten reichen von 1993 bis zum Ende von 1998. Es scheint unwahrscheinlich, dass im Jahr 1998 keine weiteren Konten eröffnet worden sind. Es ist anzunehmen, dass die Daten über die Konten von 1998 nicht veröffentlicht worden sind.

## Kumulierte Anzahl Konten von 1.1.1993 bis 29.12.1997
```{r echo=FALSE}
data_accounts_running_total <- get_accounts_running_total()
ggplot(data_accounts_running_total, aes(x=date, y=accounts_running_total)) +
  geom_line() +
  labs(x="Jahr", y="Kumulierte Anzahl Konten", title="Kumulierte Anzahl Konten von 1.1.1993 bis 29.12.1997")
```

Auffallend in der kumulierten Anzahl der Konten welche eröffnet wurden ist, dass der Zuwachs zwischen 1994 und 1997 unstetig ist. Zwischen 1994 und 1996 nimmt der Zuwach deutlich ab, wohin gegen mehr Konten im Jahr 1996 eröffnet wurden, als in den Jahren 1993 und 1997.

## Anteil Kunden pro Geschlecht
```{r echo=FALSE}
data_count_by_gender <- get_count_by_gender()

ggplot(data_count_by_gender, aes(x=gender, y=count)) + 
  geom_bar(stat = "identity", color = "black", fill = "grey") +
  geom_text(aes(label=count), vjust=-0.5) +
  labs(x="Geschlecht", y="Anzahl Kunden", title="Anzahl Kunden pro Geschlecht")
```

Die Verteilung der Frauen und Männer ist repräsentativ. Frauen machen 49.26 % und die Männer 50.74 % aller Kunden aus.

# 2. Datenbasis

## Verteilung aller Kunden pro Alter (Stichtag: 31.12.1998)
```{r echo=FALSE}
data_all_clients_age <- get_all_clients_age()
ggplot(data_all_clients_age, aes(x=age)) + 
  geom_histogram(binwidth=5, color = "black", fill = "grey") +
  scale_x_continuous(breaks = seq(0, 100, 10)) +
  labs(x="Alter", y="Anzahl Kunden", title="Verteilung aller Kunden pro Alter (Stichtag: 31.12.1998)")
```

Der grösste Anteil aller Kunden liegt im Alter zwischen 18 und 63 Jahre.

# Regionen

```{r}
all_clients_join_region_ctype <- get_all_clients_join_region_ctype()

all_clients_join_region_ctype$type <- replace_na(data = all_clients_join_region_ctype$type,
                                                 replace = "Keine Karte")

all_clients_join_region_ctype$type <- gsub(pattern = "classic", 
                                           replacement = "Classic", 
                                           x = all_clients_join_region_ctype$type)
all_clients_join_region_ctype$type <- gsub(pattern = "junior", 
                                           replacement = "Junior", 
                                           x =all_clients_join_region_ctype$type) 
all_clients_join_region_ctype$type <- gsub(pattern = "gold", 
                                           replacement = "Gold", 
                                           x = all_clients_join_region_ctype$type)

##  Visualisierung Anzahl Kunden und Kartentypen nach Region eingeteilt
all_clients_join_region_ctype %>%
  ggplot(aes(x = region, fill = type)) +
  geom_bar(position = "stack") + 
  labs(title = "Anzahl der Kunden nach Region", subtitle = "Gesamtanzahl Kunden: 5369", fill = "Kartentyp") +
  xlab(label = "Regionen") +
  ylab(label = "Anzahl der Konten") +
  coord_flip() +
  scale_fill_cb

```

Mit dem Plot wurde die Annahme bearbeitet, dass ein gewisser Kartentyp einem spezifischen Bezirk zugeordnet werden kann. Aus optischen Gründen um die Bezirke sauber darzustellen, wurde hier anstatt mit den Bezirken, mit den Regionen gearbeitet. Aus dem Plot ist ersichtlich, dass wieviele Kunden aus welchen Regionen stammen. Ausserdem kann man sehen, dass die Verteilung der Karten auf die einzelnen Regionen nicht viel hergibt und es nach der Anzahl her relativ gleich verteilt ist.




- S: Amount of Customers per Region with cards - DONE!
- S: Altersverteilung nach Regione Facets - Plot nicht miteinbezogen, da nicht aussagekräftig!

# Accounts

## Vergleich Accounts mit "Owner" gegenüber Accounts mit "Owner und Disponent"
```{r echo=FALSE}
data_owner_disp <- get_owner_disp()

accounts_with_count <- data_owner_disp %>%
  group_by(count_users) %>%
  summarise(count_users_new = n())

accounts_with_count_owners <- accounts_with_count$count_users_new[1]
accounts_with_count_own_disp <- accounts_with_count$count_users_new[2]

data_owner_disp %>% 
  ggplot(aes(x = count_users)) + 
  geom_bar(color = "black", fill = "grey") +
  geom_text(stat = "count", aes(label = ..count.. , vjust = -0.5) ) +
  ylab(label = "Anzahl") +
  xlab(label = "") +
  scale_x_continuous(breaks = c(1,2), labels = c("OWNER", "OWNER, DISPONENT")) +
  labs(title = "Unterteilung der Konten von 4500 Observationen", subtitle = "Unterteilung in Kunden mit Owner und Owner/Disponent") +
  scale_fill_cb

```

Anhand der Grafik kann gesehen werden, das es Accounts gibt mit einem "Owner" und einem "Owner und Disponent". Die Grafik zeigt widerum auch, dass es keine Accounts gibt, die mehr als zwei Besetzungen haben. Die Anzahl kann ebenfalls aus der Grafik gelesen werden. Die Anzahl der Accounts mit einem "Owner" beträgt `r accounts_with_count_owners` Observationen und mit einem "Owner" und einem "Disponent" `r accounts_with_count_own_disp` Observationen.



## Vergleich der Accounts mit Loans und Accounts ohne Loans
```{r}
account_loans <- as_tibble(get_account_loans()) 
head(account_loans)

account_loans %>%
  ggplot(aes(x = count, fill = count)) +
  geom_bar(color = "black", fill = "grey") +
  scale_x_continuous(breaks = c(0, 1),labels = c("Konten ohne Kredit", "Konten mit Kredit")) +
  geom_text(stat = "count", aes(label = ..count..), vjust = -0.5) +
  labs(title = "Konten mit und ohne Kredite (ges. 4500)") +
  xlab(label = "") +
  ylab(label = "Anzahl Konten")

```

Mit dem Barchart wird grob aufgezeigt wieviele Konten über einen Kredit verfügen und wieviele nicht.  Er zeigt, dass es eigentliches Potenzial an Kunden vorhanden wäre, die einen Kredit aufnehmen könnten. Der Plot identifiziert ein mögliches Geschäftsfeld der Bank zur Gewinnung potenzieller Kunden.



## Anzahl des Status der Kredite und Anzahl ausgestellte Kredite
```{r}
accounts_loans <- get_accounts_with_loans()

## Anzeige Loan Status (Code)
accounts_with_loans <- na.omit(accounts_loans) %>%
  rename(date_of_loan = date) %>%
  mutate(running_finished = if_else(str_detect(string = payment_status, pattern = "finished") ,
                                    "Finished", "Running")) 
## Anzeige Loan Status (Plot)
accounts_with_loans %>%
ggplot(aes(x = payment_status, fill = running_finished)) + 
  geom_bar(color= "black") +
  xlab(label = "Kreditstatus") +
  ylab(label = "Anzahl der Konten") +
  scale_fill_cb +
  labs(title = "Anzahl der Kreditstatus", subtitle = "Die Balken zeigen die Anzahl der Loans mit deren Bezahlstatus von gesamthaft 682 Krediten") +
  geom_text(stat = "count", aes(label = ..count..), vjust = -0.5) 

## Anzeige der ausgestellten Loans pro Monat (Code)
accounts_with_loans_loandate_only <- accounts_with_loans %>%
  transmute(date_of_loan) %>%
  arrange() %>%
  separate(col = date_of_loan,into = c("year", "month", "day") ,sep = "-", convert = ) %>%
  unite(c("year", "month") ,col = date_loan_yr_mth, sep = "-") %>%
  transmute(date_loan_yr_mth) %>%
  group_by(date_loan_yr_mth) %>%
  summarise(loan_count = n())

## Anzege der ausgestellten Loans pro Monat (Plot)
accounts_with_loans_loandate_only %>%
  ggplot(aes(x = date_loan_yr_mth, y = loan_count)) +
  geom_col(color = "black", fill = "grey")+
  labs(title = "Anzahl ausgestellte Loans auf Monate aufgeteilt", 
       subtitle = "Anzeige der ausgestellten Loans pro Monat") +
  scale_x_discrete(breaks = c("1993-01", "1994-01","1995-01", "1996-01","1997-01","1998-01"))+
  xlab(label = "Zeitachse in Jahre") +
  ylab(label = "Anzahl Loans")

```

Auf der ersten Grafik sieht man die Anzahl der ausgestellten Kredite mit deren Bezahlstatus. Es sind wenige Kredite vorhanden, die nicht fertig sind und nicht bezahlt wurden im Gegensatz zu denen, welche bezahlt wurden. Die Verhältnisse von denn die nicht bezahlt wurden zu denen, die bezahlt wurden sind etwa gleich. Die Bank hat zum Zeitpunkt 1999 viele laufende Kredite, von welchen wenige in Rückstand sind.
Im zweiten Plot ist die Anzahl der ausgestellten Kredite auf einer Zeitachse dargestellt. Es ist zu sehen, dass die ersten Kredite erst im Jahre 1993 ausgestellte wurden. Dabei ist anzunehmen, dass das Kreditgeschäft erst zu diesem Zeitpunkt gestartet hat oder die Bank ihr Geschäft aufgenommen hat. Man sieht einen steigenden Trend in der Anzahl der ausgestellten Kredite auf jüngere Jahre.



x- S: Anzahl Konten mit Loans und Konten ohne Loans - DONE!
- M: Line Plot mit den Summierungen von Accounts
- G: Vermögen 98'

# Loans
## Verlgeich der Loans und Status nach Geschlecht
```{r}
loan_clients <- get_loan_clients() 

## Darstellung ausgestellte Lonas nach geschlecht und Bezahlstatus (Plot)
loan_clients %>%
ggplot(aes(x = gender, fill = loan_status)) +
  geom_bar() +
  labs(title = "Kreditvergabe nach Geschlecht und deren Status", fill = "Kreditstatus") +
  scale_fill_cb +
  xlab( "Geschlecht") +
  ylab("Anzahl ausgestellte Kredite")
```

Bei diesem Plot wurden die Account_id berücksichtigt, also die Accounts, welche über einen Kredit verfügen.
Mit diesem Plot wurde die Hypothese, dass es Signifikante Unterschiede nach Geschlecht gibt bei der Vergabe von Krediten, bearbeitet. Er wiederlegt, dass die Hypothese nicht korrekt ist. Es sind keine grossen Untershiede vorhanden in der Anzahl, sowohl auch beim Kreditstatus. 





- G: Beweis Account nur ein loan
x- S: Übersicht Loans mit Status 
x- S: Loans über Jahr mit binwidth pro Monat dargestellt
- S: Loan amount on card type: Wenig Daten, vorsicht lieber Simon.
x- S: Loan auf Geschlecht, Loan status. Das farbige.
- S: Loan Altersverteiung Timeframe, Alter zu Loan Ausstelldatum

# Karten
- S: Number of counts for each service construct + Time-Frame anpassen!

# Trans
- G: Genauigkeitsüberprüfung
- G: Analyse fehlende Werte
- G: Warum VYBER?

# 5. Kreditkarten

## Anzahl ausgestelle Karten pro Kartentyp
```{r echo=FALSE}
data_card_count_by_card_type <- get_card_count_by_card_type()
ggplot(data_card_count_by_card_type, aes(x=type, y=count)) + 
  geom_bar(stat = "identity", color = "black", fill = "grey") +
  geom_text(aes(label=count), vjust=-0.5) +
  labs(x="Kreditkarten Typ", y="Anzahl Kreditkarten", title="Anzahl ausgestelle Karten pro Kartentyp")
```

Insgesamt sind 892 Kreditkarten im Umlauf:

* 659 Classic
* 145 Junior
* 88 Gold.

## Verteilung der Kreditkarten pro Account und Disponent
```{r echo=FALSE}
data_distinct_accounts_by_card <- get_distinct_accounts_by_card()
head(data_distinct_accounts_by_card)
```

Kein Konto hat mehrere Kreditkarten. Das heisst, dass 892 verschiedene Konten eine Kreditkarte besitzen.

```{r echo=FALSE}
data_card_count_by_disp_type <- get_card_count_by_disp_type()
head(data_card_count_by_disp_type)
```

Alle Kartenbesitzer sind auch Inhaber (Owner) der entsprechenden Konten.  
Aus der Beschreibung der Daten geht jedoch hervor, dass es erlaubt ist, mehrere Karten pro Konto zu besitzen: «more credit cards can be issued to an account».  
Ein zusätzliches Business könnte also sein, weitere Kreditkarten für die selben Konten an Disponenten zu vergeben.  
Hier ist zuerst mit der Bank zu prüfen, ob es einen Grund gibt, warum dies nicht bereits so gehandhabt wurde.

## Alter der Kunden beim Ausstelldatum der Kreditkarte
```{r echo=FALSE}
data_client_age_by_issued_date <- get_client_age_by_issued_date()

ggplot(data = data_client_age_by_issued_date, mapping = aes(x = age_on_card_issue, color=type)) +
  geom_freqpoly(binwidth=4) +
  labs(x="Alter beim Ausstelldatum der Kreditkarte", y="Anzahl Kreditkarten", title="Alter der Kunden beim Ausstelldatum der Kreditkarte")
```

Gemäss den Daten wird die Junior-Kreditkarte nur an unter 25 Jährige vergeben.
Da laut den Daten 55 Kunden unter 18 Jahren sind welche eine Kreditkarte erhalten haben, scheint es erlaubt zu sein, Kreditkarten an nicht volljährige Personen zu vergeben.

```{r echo=FALSE}
data_client_age_by_issued_date <- get_client_age_by_issued_date()
data_clients_without_credit_card_0_100 <- get_clients_without_credit_card_by_age_range(0, 100)

ggplot() +
  geom_freqpoly(data = data_client_age_by_issued_date, mapping = aes(x = age_on_card_issue), binwidth=4, color="blue") +
  geom_freqpoly(data = data_clients_without_credit_card_0_100, mapping = aes(x = age), binwidth=4, color="red") +
  xlab('Alter') +
  ylab('Anzahl') +
  scale_x_continuous(breaks = seq(10,90,5)) +
  labs(x="Alter", y="Anzahl Kunden", title="Alter der Kunden Ausstelldatum Kreditkarte / Kunden ohne Karte (31.12.1998)")
```

Die blaue Linie ist das Alter der Kunden bei ausstellung der Kreditkarte. Die rote Linie sind alle Kunden und Alter welche keine Kreditkarte haben zum Stichtag 31.12.1998.

Da ausgestellte Kreditkarten ab 55-jährige rasant abnimmt, macht es keinen Sinn, über 55 Jährige die Kreditkarte zu bewerben.

## Kunden ohne Kreditkarten

Insgesamt gibt es 514 Clients welche Besitzer (owner) eines Accounts sind, welche keine Kreditkarte besitzen und unter 25 Jahre sind. Dies wären potentielle Kunden für die Junior-Kreditkarte.  
Die ersten 6:
```{r echo=FALSE}
data_clients_wihtout_credit_card_by_age_range_0_25 <- get_clients_without_credit_card_by_age_range(0, 25)
head(data_clients_wihtout_credit_card_by_age_range_0_25)
```

Insgesamt gibt es 3094 Clients welche Besitzer (owner) eines Accounts sind, welche keine Kreditkarte besitzen und über 24 Jahre sind.  
Die ersten 6:

```{r echo=FALSE}
data_clients_wihtout_credit_card_by_age_range_24_100 <- get_clients_without_credit_card_by_age_range(24, 100)
head(data_clients_wihtout_credit_card_by_age_range_24_100)
```

```{r echo=FALSE}
disconnect()
```

