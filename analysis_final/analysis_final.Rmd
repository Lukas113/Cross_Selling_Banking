---
title: "Analyse zu «HS19C2 - Cross-Selling in Banking»"
author:
  - Lukas Gehrig, Simon Stähli, Lukas Märki
date: "`r format(Sys.time(), '%d.%m.%Y')`"
output:
  html_document:
    df_print: paged
    css: style.css
  pdf_document: default
---

```{r message=FALSE, echo=FALSE}
source('inc/header.R')
```

Aufgabestellung, etc.  
Kunde: Prof. Dr. Daniel Perruchoud

```{r}
cbPalette <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")
scale_fill_cb <- scale_fill_manual(values = cbPalette)
scale_color_cb <- scale_color_manual(values = cbPalette)
```


# 1. Qualität und Representativität der Daten

In den Daten sind alle Konten enthalten, welche im Zeitraum von 1.1.1993 bis 29.12.1997 eröffnet worden sind. Insgesamt sind 4'500 Konten in diesem Zeitraum eröffnet worden.  
Die Daten der getätigten Transaktionen und Ausstelldaten der Kreditkarten reichen von 1993 bis zum Ende von 1998. Es scheint unwahrscheinlich, dass im Jahr 1998 keine weiteren Konten eröffnet worden sind. Es ist anzunehmen, dass die Daten über die Konten von 1998 nicht veröffentlicht worden sind.

## Kumulierte Anzahl Konten von 1.1.1993 bis 29.12.1997
```{r echo=FALSE}
data_accounts_running_total <- get_accounts_running_total()
ggplot(data_accounts_running_total, aes(x=date, y=accounts_running_total)) +
  geom_line() +
  labs(x="Jahre", y="Kumulierte Anzahl Konten")
```

Auffallend in der kumulierten Anzahl der Konten welche eröffnet wurden ist, dass der Zuwachs zwischen 1994 und 1997 unstetig ist. Zwischen 1994 und 1996 nimmt der Zuwach deutlich ab, wohin gegen mehr Konten im Jahr 1996 eröffnet wurden, als in den Jahren 1993 und 1997.

## Verteilung aller Kunden pro Alter (Stichtag: 31.12.1998)
```{r echo=FALSE}
data_all_clients_age <- get_all_clients_age()
ggplot(data_all_clients_age, aes(x=age)) + 
  geom_histogram(binwidth=5) +
  scale_x_continuous(breaks = seq(0, 100, 10)) +
  labs(x='Alter', y='Anzahl')
```



## Anteil Kunden pro Geschlecht
```{r echo=FALSE}
data_count_by_gender <- get_count_by_gender()

ggplot(data_count_by_gender, aes(x=gender, y=count)) + 
  geom_bar(stat = "identity") +
  geom_text(aes(label=count), vjust=-0.5)
```

Die Verteilung der Frauen und Männer ist repräsentativ. Frauen machen 49.26 % und die Männer 50.74 % aller Kunden aus.

# Schritte
- Qualität und Representativität
- 

# Regionen

```{r}
all_clients_join_region_ctype <- get_all_clients_join_region_ctype()

all_clients_join_region_ctype$type <- replace_na(data = all_clients_join_region_ctype$type,
                                                 replace = "Keine Karte")

all_clients_join_region_ctype$type <- gsub(pattern = "classic", 
                                           replacement = "Classic", 
                                           x = all_clients_join_region_ctype$type)
all_clients_join_region_ctype$type <- gsub(pattern = "junior", 
                                           replacement = "Junior", 
                                           x =all_clients_join_region_ctype$type) 
all_clients_join_region_ctype$type <- gsub(pattern = "gold", 
                                           replacement = "Gold", 
                                           x = all_clients_join_region_ctype$type)

##  Visualisierung Anzahl Kunden und Kartentypen nach Region eingeteilt
all_clients_join_region_ctype %>%
  ggplot(aes(x = region, fill = type)) +
  geom_bar(position = "stack") + 
  labs(title = "Anzahl der Kunden nach Region", subtitle = "Gesamtanzahl Kunden: 5369") +
  xlab(label = "Regionen") +
  ylab(label = "Anzahl der Konten") +
  coord_flip() +
  scale_fill_cb

```

Mit dem Plot wurde die Annahme bearbeitet, dass ein gewisser Kartentyp einem spezifischen Bezirk zugeordnet werden kann. Aus optischen Gründen um die Bezirke sauber darzustellen, wurde hier anstatt mit den Bezirken, mit den Regionen gearbeitet. Aus dem Plot ist ersichtlich, dass wieviele Kunden aus welchen Regionen stammen. Ausserdem kann man sehen, dass die Verteilung der Karten auf die einzelnen Regionen nicht viel hergibt und es nach der Anzahl her relativ gleich verteilt ist.




- S: Amount of Customers per Region with cards - DONE!
- S: Altersverteilung nach Regione Facets - Plot nicht miteinbezogen, da nicht aussagekräftig!

# Accounts

## Vergleich Accounts mit "Owner" gegenüber Accounts mit "Owner und Disponent"
```{r echo=FALSE}
data_owner_disp <- get_owner_disp()

accounts_with_count <- data_owner_disp %>%
  group_by(count_users) %>%
  summarise(count_users_new = n())

accounts_with_count_owners <- accounts_with_count$count_users_new[1]
accounts_with_count_own_disp <- accounts_with_count$count_users_new[2]

data_owner_disp %>% 
  ggplot(aes(x = count_users)) + 
  geom_bar(fill = "lightblue", color = "black") +
  geom_text(stat = "count", aes(label = ..count.. , vjust = -0.5) ) +
  ylab(label = "Anzahl") +
  scale_x_continuous(breaks = c(1,2), labels = c("OWNER", "OWNER, DISPONENT")) +
  labs(title = "Unterteilung der Konten von 4500 Observationen", subtitle = "Unterteilung in Kunden mit Owner und Owner/Disponent")

```

Anhand der Grafik kann gesehen werden, das es Accounts gibt mit einem "Owner" und einem "Owner und Disponent". Die Grafik zeigt widerum auch, dass es keine Accounts gibt, die mehr als zwei Besetzungen haben. Die Anzahl kann ebenfalls aus der Grafik gelesen werden. Die Anzahl der Accounts mit einem "Owner" beträgt `r accounts_with_count_owners` Observationen und mit einem "Owner" und einem "Disponent" `r accounts_with_count_own_disp` Observationen.






## Vergleich der Accounts mit Loans und Accounts ohne Loans

```{r}
account_loans <- as_tibble(get_account_loans()) 
head(account_loans)

account_loans %>%
  ggplot(aes(x = count, fill = count)) +
  geom_bar(fill = "lightblue", color = "black") +
  scale_x_continuous(breaks = c(0, 1),labels = c("Konten ohne Kredit", "Konten mit Kredit")) +
  geom_text(stat = "count", aes(label = ..count..), vjust = -0.5) +
  labs(title = "Konten mit und ohne Kredite (ges. 4500)") +
  xlab(label = "") +
  ylab(label = "Anzahl Konten")

```

Mit dem Barchart wird grob aufgezeigt wieviele Konten über einen Kredit verfügen und wieviele nicht.  Er zeigt, dass es eigentliches Potenzial an Kunden vorhanden wäre, die einen Kredit aufnehmen könnten. Der Plot identifiziert ein mögliches Geschäftsfeld der Bank zur Gewinnung potenzieller Kunden.







- S: Anzahl Konten mit Loans und Konten ohne Loans - DONE!
- M: Line Plot mit den Summierungen von Accounts
- G: Vermögen 98'

# Loans

```{r}

loan_clients <- get_loan_clients() 



loan_clients %>%
ggplot(aes(x = gender, fill = loan_status)) +
  geom_bar(alpha = 3/4) +
  labs(title = "Anz. M/F, welche einen Loan haben")

```




- G: Beweis Account nur ein loan
- S: Übersicht Loans mit Status
- S: Loans über Jahr mit binwidth = 3
- S: Loan amount on card type: Wenig Daten, vorsicht lieber Simon.
- S: Loan auf Geschlecht, Loan status. Das farbige.
- S: Loan Altersverteiung Timeframe, Alter zu Loan Ausstelldatum

# Karten
- S: Number of counts for each service construct

# Trans
- G: Genauigkeitsüberprüfung
- G: Analyse fehlende Werte
- G: Warum VYBER?


## Anzahl Karten pro Kartentyp
```{r echo=FALSE}
data_card_count_by_card_type <- get_card_count_by_card_type()
ggplot(data_card_count_by_card_type, aes(x=type, y=count)) + 
  geom_bar(stat = "identity") +
  geom_text(aes(label=count), vjust=0)
```

Insgesamt sind 892 Kreditkarten im Umlauf:

* 659 Classic
* 145 Junior
* 88 Gold.

## Verteilung der Kreditkarten pro Account und Disponent
```{r echo=FALSE}
data_distinct_accounts_by_card <- get_distinct_accounts_by_card()
ggplot(data_distinct_accounts_by_card, aes(x=accounts, y=count)) + 
  geom_bar(stat = "identity") +
  geom_text(aes(label=count), vjust=0)
```

Kein Konto hat mehrere Kreditkarten. (892 verschiedene Konten)

```{r echo=FALSE}
data_card_count_by_disp_type <- get_card_count_by_disp_type()
ggplot(data_card_count_by_disp_type, aes(x=type, y=count)) + 
  geom_bar(stat = "identity") +
  geom_text(aes(label=count), vjust=0)
```

Alle Kartenbesitzer sind auch Inhaber (Owner) der entsprechenden Konten.  Aus der Beschreibung der Daten geht jedoch hervor, dass es erlaubt ist, mehrere Karten pro Konto zu besitzen: «more credit cards can be issued to an account».  
Ein zusätzliches Business könnte also sein, weitere Kreditkarten für die selben Konten an Disponenten zu vergeben.  
Hier ist zuerst mit der Bank zu prüfen, ob es einen Grund gibt, warum dies nicht bereits so gehandhabt wurde.

## Altersverteilung beim Ausstelldatum der Kreditkarte.
```{r echo=FALSE}
data_client_age_by_issued_date <- get_client_age_by_issued_date()

ggplot(data = data_client_age_by_issued_date, mapping = aes(x = age_on_card_issue, color=type)) +
  geom_freqpoly(binwidth=4)
```

Gemäss den Daten wird die Junior-Kreditkarte nur an unter 25 Jährige vergeben.
Da laut den Daten 55 Kunden unter 18 Jahren sind welche eine Kreditkarte erhalten haben, scheint es erlaubt zu sein, Kreditkarten an nicht volljährige Personen zu vergeben.

```{r echo=FALSE}
data_client_age_by_issued_date <- get_client_age_by_issued_date()
data_clients_without_credit_card_0_100 <- get_clients_without_credit_card_by_age_range(0, 100)

ggplot() +
  geom_freqpoly(data = data_client_age_by_issued_date, mapping = aes(x = age_on_card_issue), binwidth=4, color="blue") +
  geom_freqpoly(data = data_clients_without_credit_card_0_100, mapping = aes(x = age), binwidth=4, color="red") +
  xlab('Alter') +
  ylab('Anzahl') +
  scale_x_continuous(breaks = seq(10,90,5))
```

Die blaue Linie ist das Alter der Kunden bei ausstellung der Kreditkarte. Die rote Linie sind alle Kunden und Alter welche keine Kreditkarte haben zum Stichtag 31.12.1998.

Da ausgestellte Kreditkarten ab 55-jährige rasant abnimmt, macht es keinen Sinn, über 55 Jährige die Kreditkarte zu bewerben.

## Kunden ohne Kreditkarten

Insgesamt gibt es 514 Clients welche Besitzer (owner) eines Accounts sind, welche keine Kreditkarte besitzen und unter 25 Jahre sind. Dies wären potentielle Kunden für die Junior-Kreditkarte.  
Die ersten 6:
```{r echo=FALSE}
data_clients_wihtout_credit_card_by_age_range_0_25 <- get_clients_without_credit_card_by_age_range(0, 25)
head(data_clients_wihtout_credit_card_by_age_range_0_25)
```

Insgesamt gibt es 3094 Clients welche Besitzer (owner) eines Accounts sind, welche keine Kreditkarte besitzen und über 24 Jahre sind.  
Die ersten 6:

```{r echo=FALSE}
data_clients_wihtout_credit_card_by_age_range_24_100 <- get_clients_without_credit_card_by_age_range(24, 100)
head(data_clients_wihtout_credit_card_by_age_range_24_100)
```

```{r echo=FALSE}
disconnect()
```

